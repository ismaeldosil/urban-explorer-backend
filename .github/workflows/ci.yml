name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-migrations:
    name: Lint Migrations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Validate migrations syntax
        run: |
          echo "Validating SQL migrations..."
          for file in supabase/migrations/*.sql; do
            echo "Checking $file"
            # Basic syntax check - ensure file is valid UTF-8 and has content
            if [ -f "$file" ]; then
              head -1 "$file" > /dev/null || exit 1
            fi
          done
          echo "All migrations validated"

  test-database:
    name: Test Database Schema
    runs-on: ubuntu-latest
    needs: lint-migrations

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Start Supabase
        run: supabase start -x realtime,storage-api,imgproxy,inbucket,pgadmin-schema-diff,migra,postgres-meta,studio,edge-runtime,logflare,vector,supavisor

      - name: Run migrations
        run: supabase db push

      - name: Verify schema
        run: |
          echo "Verifying database schema..."
          supabase db lint

      - name: Stop Supabase
        if: always()
        run: supabase stop

  security-check:
    name: Security Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets in code
        run: |
          echo "Checking for hardcoded secrets..."
          # Check for common secret patterns
          if grep -rE "(password|secret|api_key|apikey)\s*=\s*['\"][^'\"]+['\"]" --include="*.sql" --include="*.ts" --include="*.js" supabase/ 2>/dev/null; then
            echo "WARNING: Possible hardcoded secrets found"
            exit 1
          fi
          echo "No hardcoded secrets detected"

      - name: Check RLS policies
        run: |
          echo "Checking for RLS in migrations..."
          rls_count=$(grep -l "ENABLE ROW LEVEL SECURITY" supabase/migrations/*.sql 2>/dev/null | wc -l)
          echo "Found $rls_count migrations with RLS enabled"

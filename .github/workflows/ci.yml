name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-migrations:
    name: Lint Migrations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Validate migrations syntax
        run: |
          echo "Validating SQL migrations..."
          for file in supabase/migrations/*.sql; do
            echo "Checking $file"
            # Basic syntax check - ensure file is valid UTF-8 and has content
            if [ -f "$file" ]; then
              head -1 "$file" > /dev/null || exit 1
            fi
          done
          echo "All migrations validated"

  test-database:
    name: Test Database Schema
    runs-on: ubuntu-latest
    needs: lint-migrations

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Start Supabase
        run: supabase start -x realtime,storage-api,imgproxy,inbucket,pgadmin-schema-diff,migra,postgres-meta,studio,edge-runtime,logflare,vector,supavisor

      - name: Run migrations
        run: supabase db push

      - name: Verify schema
        run: |
          echo "Verifying database schema..."
          supabase db lint

      - name: Stop Supabase
        if: always()
        run: supabase stop

  security-check:
    name: Security Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets in code
        run: |
          echo "Checking for hardcoded secrets..."
          # Check for common secret patterns
          if grep -rE "(password|secret|api_key|apikey)\s*=\s*['\"][^'\"]+['\"]" --include="*.sql" --include="*.ts" --include="*.js" supabase/ 2>/dev/null; then
            echo "WARNING: Possible hardcoded secrets found"
            exit 1
          fi
          echo "No hardcoded secrets detected"

      - name: Check RLS policies
        run: |
          echo "Checking for RLS in migrations..."
          rls_count=$(grep -l "ENABLE ROW LEVEL SECURITY" supabase/migrations/*.sql 2>/dev/null | wc -l)
          echo "Found $rls_count migrations with RLS enabled"

  test-edge-functions:
    name: Test Edge Functions
    runs-on: ubuntu-latest
    needs: test-database

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Start Supabase (with Edge Runtime)
        run: supabase start -x realtime,storage-api,imgproxy,inbucket,pgadmin-schema-diff,migra,postgres-meta,studio,logflare,vector,supavisor

      - name: Validate Edge Functions syntax
        run: |
          echo "Validating Edge Functions TypeScript syntax..."
          if [ -d "supabase/functions" ]; then
            for func_dir in supabase/functions/*/; do
              if [ -d "$func_dir" ] && [ -f "$func_dir/index.ts" ]; then
                func_name=$(basename "$func_dir")
                echo "Checking $func_name..."
                deno check "$func_dir/index.ts"
              fi
            done
            echo "All Edge Functions validated"
          else
            echo "No Edge Functions found"
          fi

      - name: Lint Edge Functions
        run: |
          echo "Linting Edge Functions..."
          if [ -d "supabase/functions" ]; then
            for func_dir in supabase/functions/*/; do
              if [ -d "$func_dir" ] && [ -f "$func_dir/index.ts" ]; then
                func_name=$(basename "$func_dir")
                echo "Linting $func_name..."
                deno lint "$func_dir/index.ts"
              fi
            done
            echo "All Edge Functions linted"
          fi

      - name: Test Edge Functions locally
        run: |
          echo "Testing Edge Functions..."
          # Serve functions in background
          supabase functions serve &
          SERVE_PID=$!

          # Wait for functions to be ready
          sleep 10

          # Test each function with basic health check
          if [ -d "supabase/functions" ]; then
            for func_dir in supabase/functions/*/; do
              if [ -d "$func_dir" ]; then
                func_name=$(basename "$func_dir")
                echo "Testing $func_name..."

                # Basic OPTIONS request (CORS check)
                curl -i -X OPTIONS \
                  http://localhost:54321/functions/v1/$func_name \
                  -H "Authorization: Bearer $(supabase status --output json | jq -r '.anon_key')" \
                  || echo "Warning: $func_name OPTIONS check failed"
              fi
            done
          fi

          # Stop the serve process
          kill $SERVE_PID 2>/dev/null || true

      - name: Stop Supabase
        if: always()
        run: supabase stop
